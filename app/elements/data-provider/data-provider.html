<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="data-provider">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
      auto
      verbose="true"
      url="{{hubId}}"
      handle-as="json"
      on-response="handleHubResponse"
      debounce-duration="300"></iron-ajax>

   <iron-ajax
      auto
      verbose="true"
      url="{{sportListId}}"
      handle-as="json"
      on-response="handleSportListResponse"
      debounce-duration="300"></iron-ajax>

  <iron-ajax
      auto      
      verbose="true"
      url="{{placeListId}}"    
      handle-as="json"
      on-response="handlePlaceListResponse"
      debounce-duration="300"></iron-ajax>

   <iron-ajax
      auto      
      verbose="true"
      url="{{peopleListId}}"    
      handle-as="json"
      on-response="handlePeopleListResponse"
      debounce-duration="300"></iron-ajax>

  <iron-ajax
      auto      
      verbose="true"
      url="{{activityListId}}"    
      handle-as="json"
      on-response="handleActivityListResponse"
      debounce-duration="300"></iron-ajax>

  </template>
  <script>
  (function() {
    'use strict';

    /* global _ */

    Polymer({
      is: 'data-provider',

      properties: {
        hubId: {
          type: String,
          value: 'http://sporthub.demo.hackers4peace.net/',
          notify: true
        },
        data: {
          type: Object,         
          notify: true
        },
        sportListId: {
          type: String
        },
        placeListId: {
          type: String
        },
        peopleListId: {
          type: String
        },
        sportListLoaded: {
          type: Boolean,
          value: false          
        },
        placeListLoaded: {
          type: Boolean,
          value: false
        },
        peopleListLoaded: {
          type: Boolean,
          value: false
        },
        activityListLoaded: {
          type: Boolean,
          value: false
        },
        dataReady: {
          type: Boolean,          
          notify: true,
          computed: 'getDataReady(sportListLoaded,placeListLoadedm,peopleListLoaded)',
        }
      },
      observers: [
         'currentActivityChanged(data.current.activity)',
      ],
      currentActivityChanged: function(newval) {
        console.log(newval);
      },
      getDataReady: function (sportListLoaded, placeListLoaded, peopleListLoaded, activityListLoaded) {
          var isReady = sportListLoaded && placeListLoaded && peopleListLoaded && activityListLoaded;

          if (isReady) {
            console.log('data is ready!');
          }

          return isReady;
      },

      handleHubResponse: function (e) {            
        //get the root element
        var graph = e.detail.response['@graph'];                            

        //get dataset      
        var datasetId = _.find(graph, 'id', this.hubId).describes;
        var dataset = _.find(graph, 'id', datasetId);

        //get lists identifiers from dataset
        this.sportListId = _.find(dataset['void:classPartition'], 'void:class', 'dbpo:Sport').id;
        this.placeListId = _.find(dataset['void:classPartition'], 'void:class', 'as:Place').id;
        this.peopleListId = _.find(dataset['void:classPartition'], 'void:class', 'foaf:Person').id;
        this.activityListId = _.find(dataset['void:classPartition'], 'void:class', 'as:Activity').id;

        console.log(this.peopleListId);
      },

      handleSportListResponse: function (e) {
        var respData = e.detail.response;
        var graph = respData['@graph'];

        this.set('data.sports', graph[0].contains);

        this.sportListLoaded = true;
      },

      handlePlaceListResponse: function (e) {
        var respData = e.detail.response;
        var graph = respData['@graph'];
        
        this.set('data.places', graph[0].contains);

        this.placeListLoaded = true;
      },

      handlePeopleListResponse: function (e) {
        var respData = e.detail.response;
        var graph = respData['@graph'];
        
        //FIXME: replace hardcoded indexes

        this.set('data.people', graph[1].contains);

        console.log('people', graph[1].contains);

        this.peopleListLoaded = true;
      },

       handleActivityListResponse: function (e) {

        var respData = e.detail.response;
        var graph = respData['@graph'];
        
        //FIXME: replace hardcoded indexes

        this.set('data.activities', graph[0].contains);

        console.log('activities', graph[0].contains);

        this.activityListLoaded = true;
      }

    });
  })();
  </script>
</dom-module>
